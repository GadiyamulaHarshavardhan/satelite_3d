<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>ISS 3D Tracker</title>
  <script src="https://cesium.com/downloads/cesiumjs/releases/1.117/Build/Cesium/Cesium.js"></script>
  <link href="https://cesium.com/downloads/cesiumjs/releases/1.117/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
  <style> #cesiumContainer { width: 100%; height: 100vh; }</style>
</head>
<body>
  <div id="cesiumContainer"></div>
  <script type="module">
    import * as satellite from 'https://cdn.skypack.dev/satellite.js';

    const viewer = new Cesium.Viewer('cesiumContainer', {
      shouldAnimate: true,
      timeline: false,
      animation: false
    });

    // Fetch TLE
    const res = await fetch("https://celestrak.org/NORAD/elements/gp.php?CATNR=25544&FORMAT=JSON");
    const tle = (await res.json())[0];
    const satrec = satellite.twoline2satrec(tle.TLE_LINE1, tle.TLE_LINE2);

    // Create dynamic position property
    const positionProperty = new Cesium.SampledPositionProperty();

    // Pre-compute orbit for next 90 minutes (ISS orbit period)
    const now = Cesium.JulianDate.now();
    for (let i = 0; i < 540; i += 10) { // every 10 sec for 90 min
      const jsDate = new Date(Cesium.JulianDate.toDate(now).getTime() + i * 1000);
      const positionAndVelocity = satellite.propagate(satrec, jsDate);
      if (!positionAndVelocity.position) continue;

      const gmst = satellite.gstime(jsDate);
      const posEci = positionAndVelocity.position;
      const geodetic = satellite.eciToGeodetic(posEci, gmst);
      const lat = satellite.degreesLat(geodetic.latitude);
      const lon = satellite.degreesLong(geodetic.longitude);
      const alt = geodetic.height * 1000; // km â†’ meters

      const cartographic = Cesium.Cartographic.fromDegrees(lon, lat, alt);
      const position = Cesium.Cartesian3.fromRadians(
        cartographic.longitude,
        cartographic.latitude,
        cartographic.height
      );
      positionProperty.addSample(Cesium.JulianDate.fromDate(jsDate), position);
    }

    // Add ISS entity
    viewer.entities.add({
      name: 'ISS',
      position: positionProperty,
      orientation: new Cesium.VelocityOrientationProperty(positionProperty),
      point: { pixelSize: 10, color: Cesium.Color.RED },
      path: {
        resolution: 10,
        material: new Cesium.PolylineGlowMaterialProperty({ glowPower: 0.1, color: Cesium.Color.CYAN }),
        width: 3,
        leadTime: 0,
        trailTime: 3600 // 1-hour trail
      }
    });

    viewer.trackedEntity = viewer.entities.values[0];
  </script>
</body>
</html>
